<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Origin Form - Login</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #f5f5f5;
      min-height: 100vh;
    }

    .header {
      background-color: #ffffff;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }

    .header h1 {
      color: #333;
      font-size: 24px;
      font-weight: 500;
    }

    .login-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .login-card {
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #007bff;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      flex: 100%;
    }

    label {
      font-size: 14px;
      font-weight: 500;
      color: #555;
      margin-bottom: 5px;
    }

    input[type="text"],
    input[type="password"],
    select {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    select:focus {
      outline: none;
      border-color: #007bff;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .checkbox-group label {
      margin-bottom: 0;
    }

    .button-row {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-primary:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #545b62;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .loading {
      display: none;
      align-items: center;
      gap: 10px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .collapsible-header .toggle-icon {
      font-size: 12px;
      transition: transform 0.2s;
    }

    .collapsible-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .collapsible-content.collapsed {
      max-height: 0 !important;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Origin Form - Login Configuration</h1>
  </div>

  <div class="login-container">
    <div class="login-card">
      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>

      <form id="loginForm">
        <!-- Authentication Section -->
        <div class="form-section">
          <h2 class="section-title">Authentication</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="username">Username</label>
              <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" name="password" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="clientId">Client ID</label>
              <input type="text" id="clientId" name="clientId" required>
            </div>
            <div class="form-group">
              <label for="clientSecret">Client Secret</label>
              <input type="text" id="clientSecret" name="clientSecret" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="grantType">Grant Type</label>
              <input type="text" id="grantType" name="grantType" value="password" readonly>
            </div>
            <div class="form-group">
              <label for="scope">Scope</label>
              <input type="text" id="scope" name="scope">
            </div>
          </div>
        </div>

        <!-- API Configuration Section (Collapsible) -->
        <div class="form-section">
          <h2 class="section-title collapsible-header" onclick="toggleSection('apiConfig')">
            API Configuration
            <span class="toggle-icon">▼</span>
          </h2>
          <div id="apiConfig" class="collapsible-content">
            <div class="form-row">
              <div class="form-group full-width">
                <label for="baseUrlGateway">Base URL Gateway</label>
                <input type="text" id="baseUrlGateway" name="baseUrlGateway" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="baseUrlAuthenticator">Base URL Authenticator</label>
                <input type="text" id="baseUrlAuthenticator" name="baseUrlAuthenticator">
              </div>
              <div class="form-group">
                <label for="baseUrlInfrastructure">Base URL Infrastructure</label>
                <input type="text" id="baseUrlInfrastructure" name="baseUrlInfrastructure">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="baseUrlPublicInfrastructure">Base URL Public Infrastructure</label>
                <input type="text" id="baseUrlPublicInfrastructure" name="baseUrlPublicInfrastructure">
              </div>
              <div class="form-group">
                <label for="baseUrlDocuments">Base URL Documents</label>
                <input type="text" id="baseUrlDocuments" name="baseUrlDocuments">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="baseUrlBusiness">Base URL Business</label>
                <input type="text" id="baseUrlBusiness" name="baseUrlBusiness">
              </div>
              <div class="form-group">
                <label for="baseUrlSmartBank">Base URL Smart Bank</label>
                <input type="text" id="baseUrlSmartBank" name="baseUrlSmartBank">
              </div>
            </div>
          </div>
        </div>

        <!-- Form Configuration Section -->
        <div class="form-section">
          <h2 class="section-title collapsible-header" onclick="toggleSection('formConfig')">
            Form Configuration
            <span class="toggle-icon">▼</span>
          </h2>
          <div id="formConfig" class="collapsible-content">
            <div class="form-row">
              <div class="form-group">
                <label for="configUuid">Config UUID</label>
                <input type="text" id="configUuid" name="configUuid" required>
              </div>
              <div class="form-group">
                <label for="env">Environment</label>
                <select id="env" name="env">
                  <option value="Config">Config</option>
                  <option value="Dev">Dev</option>
                  <option value="Prod">Prod</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="currentLanguageIso">Language</label>
                <select id="currentLanguageIso" name="currentLanguageIso">
                  <option value="ro">Romanian (ro)</option>
                  <option value="en">English (en)</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="isDemoMode" name="isDemoMode">
                  <label for="isDemoMode">Demo Mode</label>
                </div>
              </div>
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="isDebug" name="isDebug">
                  <label for="isDebug">Debug Mode</label>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="showDisplayMode" name="showDisplayMode">
                  <label for="showDisplayMode">Show Display Mode</label>
                </div>
              </div>
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="showLanguageSelector" name="showLanguageSelector">
                  <label for="showLanguageSelector">Show Language Selector</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="button-row">
          <button type="submit" class="btn btn-primary" id="loginBtn">
            <span id="loginBtnText">Login & Open Form</span>
            <span id="loadingIndicator" class="loading">
              <span class="spinner"></span>
              Logging in...
            </span>
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset to Defaults</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let defaultConfig = {};

    /**
     * Load configuration from config.json
     */
    async function loadConfig() {
      try {
        const response = await fetch('config.json');
        if (response.ok) {
          defaultConfig = await response.json();
          populateForm(defaultConfig);
        }
      } catch (error) {
        console.warn('Could not load config.json, using empty defaults:', error);
      }
    }

    /**
     * Populate form fields with configuration values
     */
    function populateForm(config) {
      // Text inputs
      const textFields = [
        'baseUrlGateway', 'baseUrlAuthenticator', 'baseUrlPublicInfrastructure',
        'baseUrlInfrastructure', 'baseUrlDocuments', 'baseUrlBusiness',
        'baseUrlSmartBank', 'clientId', 'clientSecret', 'configUuid',
        'scope', 'grantType', 'username', 'password'
      ];

      textFields.forEach(field => {
        const element = document.getElementById(field);
        if (element && config[field] !== undefined) {
          element.value = config[field];
        }
      });

      // Select fields
      const selectFields = ['env', 'currentLanguageIso'];
      selectFields.forEach(field => {
        const element = document.getElementById(field);
        if (element && config[field] !== undefined) {
          element.value = config[field];
        }
      });

      // Checkbox fields
      const checkboxFields = ['isDemoMode', 'isDebug', 'showDisplayMode', 'showLanguageSelector'];
      checkboxFields.forEach(field => {
        const element = document.getElementById(field);
        if (element && config[field] !== undefined) {
          element.checked = config[field];
        }
      });
    }

    /**
     * Reset form to default values
     */
    function resetForm() {
      populateForm(defaultConfig);
      hideMessages();
    }

    /**
     * Toggle collapsible section
     */
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId);
      const header = content.previousElementSibling;

      content.classList.toggle('collapsed');
      header.classList.toggle('collapsed');
    }

    /**
     * Show error message
     */
    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }

    /**
     * Show success message
     */
    function showSuccess(message) {
      const successEl = document.getElementById('successMessage');
      successEl.textContent = message;
      successEl.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
    }

    /**
     * Hide all messages
     */
    function hideMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }

    /**
     * Set loading state
     */
    function setLoading(isLoading) {
      const loginBtn = document.getElementById('loginBtn');
      const btnText = document.getElementById('loginBtnText');
      const loadingIndicator = document.getElementById('loadingIndicator');

      loginBtn.disabled = isLoading;
      btnText.style.display = isLoading ? 'none' : 'inline';
      loadingIndicator.style.display = isLoading ? 'inline-flex' : 'none';
    }

    /**
     * Collect form data
     */
    function collectFormData() {
      return {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        clientId: document.getElementById('clientId').value,
        clientSecret: document.getElementById('clientSecret').value,
        grantType: document.getElementById('grantType').value,
        scope: document.getElementById('scope').value,
        baseUrlGateway: document.getElementById('baseUrlGateway').value,
        baseUrlAuthenticator: document.getElementById('baseUrlAuthenticator').value,
        baseUrlPublicInfrastructure: document.getElementById('baseUrlPublicInfrastructure').value,
        baseUrlInfrastructure: document.getElementById('baseUrlInfrastructure').value,
        baseUrlDocuments: document.getElementById('baseUrlDocuments').value,
        baseUrlBusiness: document.getElementById('baseUrlBusiness').value,
        baseUrlSmartBank: document.getElementById('baseUrlSmartBank').value,
        configUuid: document.getElementById('configUuid').value,
        env: document.getElementById('env').value,
        currentLanguageIso: document.getElementById('currentLanguageIso').value,
        isDemoMode: document.getElementById('isDemoMode').checked,
        isDebug: document.getElementById('isDebug').checked,
        showDisplayMode: document.getElementById('showDisplayMode').checked,
        showLanguageSelector: document.getElementById('showLanguageSelector').checked
      };
    }

    /**
     * Perform login request
     */
    async function performLogin(formData) {
      const tokenUrl = `${formData.baseUrlGateway}/connect/token`;

      const body = new URLSearchParams();
      body.append('client_id', formData.clientId);
      if (formData.clientSecret) {
        body.append('client_secret', formData.clientSecret);
      }
      body.append('grant_type', formData.grantType);
      body.append('username', formData.username);
      body.append('password', formData.password);
      body.append('scope', formData.scope);

      const response = await fetch(tokenUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: body.toString()
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error_description || errorData.error || `Login failed with status ${response.status}`);
      }

      return await response.json();
    }

    /**
     * Navigate to form page with configuration
     */
    function navigateToForm(formData, tokenResponse) {
      // Build query parameters for the form page
      const params = new URLSearchParams();
      params.append('token', tokenResponse.access_token);
      params.append('refreshToken', tokenResponse.refresh_token);
      params.append('configUuid', formData.configUuid);
      params.append('language', formData.currentLanguageIso);
      params.append('env', formData.env);
      params.append('debug', formData.isDebug.toString());
      params.append('demo', formData.isDemoMode.toString());
      params.append('showDisplayMode', formData.showDisplayMode.toString());
      params.append('showLanguageSelector', formData.showLanguageSelector.toString());

      // Store API URLs in sessionStorage for the form page to use
      const apiConfig = {
        baseUrlGateway: formData.baseUrlGateway,
        baseUrlAuthenticator: formData.baseUrlAuthenticator,
        baseUrlPublicInfrastructure: formData.baseUrlPublicInfrastructure,
        baseUrlInfrastructure: formData.baseUrlInfrastructure,
        baseUrlDocuments: formData.baseUrlDocuments,
        baseUrlBusiness: formData.baseUrlBusiness,
        baseUrlSmartBank: formData.baseUrlSmartBank,
        clientId: formData.clientId
      };
      sessionStorage.setItem('originFormApiConfig', JSON.stringify(apiConfig));

      // Navigate to form page
      window.location.href = `index.html?${params.toString()}`;
    }

    /**
     * Handle form submission
     */
    async function handleSubmit(event) {
      event.preventDefault();
      hideMessages();
      setLoading(true);

      try {
        const formData = collectFormData();

        // Validate required fields
        if (!formData.username || !formData.password) {
          throw new Error('Username and password are required');
        }
        if (!formData.baseUrlGateway) {
          throw new Error('Base URL Gateway is required');
        }
        if (!formData.configUuid) {
          throw new Error('Config UUID is required');
        }

        // Perform login
        const tokenResponse = await performLogin(formData);

        showSuccess('Login successful! Redirecting to form...');

        // Navigate to form page after short delay
        setTimeout(() => {
          navigateToForm(formData, tokenResponse);
        }, 1000);

      } catch (error) {
        showError(error.message || 'An error occurred during login');
        setLoading(false);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      document.getElementById('loginForm').addEventListener('submit', handleSubmit);
    });
  </script>
</body>
</html>
